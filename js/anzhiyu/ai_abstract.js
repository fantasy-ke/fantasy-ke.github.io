!function(){const{randomNum:t,basicWordCount:e,btnLink:n,key:i,Referer:a,gptName:o,switchBtn:r,mode:l}=GLOBAL_CONFIG.postHeadAiDescription,{title:s,postAI:c,pageFillDescription:d}=GLOBAL_CONFIG_SITE;let y,m=-1,u=!0,f=l,h=0,p=null,g=!1,T=null;const v=document.querySelector(".post-ai-description"),E=v.querySelector(".ai-title .anzhiyufont.anzhiyu-icon-arrow-rotate-right");let b=v.querySelector(".anzhiyu-icon-circle-dot");const L=v.querySelector(".ai-explanation");let M="",k="",I=600,w=0,A=0,S=[],q=0;const $=new IntersectionObserver((t=>{let e=t[0].isIntersecting;u=e,u&&(I=0===w?200:20,S[1]=setTimeout((()=>{A&&(w=0,A=0),0===w&&(L.innerHTML=M.charAt(0)),requestAnimationFrame(G)}),I))}),{threshold:0}),j=[function(){C(`我是文章辅助AI: ${o} GPT，点击下方的按钮，让我生成本文简介、推荐相关文章等。`)},function(){E.click()},function(){w=0,A=1,B(),u=!1,q=0,L.innerHTML="生成中. . .",M="",k="",$.disconnect(),S[2]=setTimeout((()=>{L.innerHTML=function(){let t=document.querySelectorAll(".relatedPosts-list a");if(!t.length){const e=document.querySelector(".card-widget.card-recent-post");if(!e)return"";t=e.querySelectorAll(".aside-list-item a");let n="";for(let e=0;e<t.length;e++){const i=t[e];n+=`<div class="ai-recommend-item"><span class="index">${e+1}：</span><a href="javascript:;" onclick="pjax.loadUrl('${i.href}')" title="${i.title}" data-pjax-state="">${i.title}</a></div>`}return`很抱歉，无法找到类似的文章，你也可以看看本站最新发布的文章：<br /><div class="ai-recommend">${n}</div>`}let e="";for(let n=0;n<t.length;n++){const i=t[n];e+=`<div class="ai-recommend-item"><span>推荐${n+1}：</span><a href="javascript:;" onclick="pjax.loadUrl('${i.href}')" title="${i.title}" data-pjax-state="">${i.title}</a></div>`}return`推荐文章：<br /><div class="ai-recommend">${e}</div>`}()}),600)},function(){C("正在前往博客主页...",!1),S[2]=setTimeout((()=>{window.pjax?pjax.loadUrl("/"):location.href=location.origin}),1e3)}],x=v.querySelectorAll(".ai-btn-item");function G(t){if(u)if(G.start||(G.start=t),q=t-G.start,q>=20){if(G.start=t,w<k-1){let t=M.charAt(w+1),e=/[,.，。!?！？]/.test(t)?150:20;L.firstElementChild&&L.removeChild(L.firstElementChild),L.innerHTML+=t;let n=document.createElement("div");n.className="ai-cursor",L.appendChild(n),w++,150===e&&(v.querySelector(".ai-explanation .ai-cursor").style.opacity="0.2"),w===k-1&&($.disconnect(),L.removeChild(L.firstElementChild)),S[0]=setTimeout((()=>{requestAnimationFrame(G)}),e)}}else requestAnimationFrame(G)}function B(){S.length&&S.forEach((t=>{t&&clearTimeout(t)}))}function C(t,e=!0){w=0,A=1,B(),u=!1,q=0,$.disconnect(),L.innerHTML=e?"生成中. . .":"请等待. . .",M=t,k=M.length,$.observe(v)}async function H(t=e){"fantasy"===f?await async function(t){w=0,A=1,B(),u=!1,q=0,$.disconnect(),t=Math.max(10,Math.min(2e3,t));const e=(s+d).trim().substring(0,t),n={postId:s,content:e};try{let t,e=null;e&&clearInterval(e),e=setInterval((()=>{const t="生成中"+".".repeat(A);L.innerHTML=t,A=A%3+1}),500);const i=await fetch(`https://summary-api.fantasyke.cn/api/summary?postId=${s}`,{method:"GET"}),a=await i.json();if(a.isSave)t=a.data.trim();else{const e=await fetch("https://summary-api.fantasyke.cn/api/summary",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),i=await e.json();1===i.code?t=i.data.trim():console.error("Error:",i)}T=s,setTimeout((()=>{E.style.opacity="1"}),300),C(t||"摘要获取失败!!!请检查Tianli服务是否正常!!!"),clearInterval(e)}catch(t){console.error(t),L.innerHTML="发生异常"+t}}(t):function(){const t=c.split(",").map((t=>t.trim()));if(1!==t.length){let e=Math.floor(Math.random()*t.length);for(;e===m;)e=Math.floor(Math.random()*t.length);m=e,C(t[e])}else C(t[0]);setTimeout((()=>{E.style.opacity="1"}),600)}()}Array.from(x).filter((t=>"go-tianli-blog"!==t.id)).forEach(((t,e)=>{t.addEventListener("click",(()=>{j[e]()}))})),document.getElementById("ai-tag").addEventListener("click",(function(){v.querySelectorAll(".ai-btn-item").forEach((t=>t.style.display="block")),document.getElementById("go-tianli-blog").style.display="none",C(`你好，我是本站摘要生成助理${o} GPT，是一个基于GPT-4的生成式AI。我在这里只负责摘要的预生成和显示，你无法与我直接沟通。`)})),E.addEventListener("click",(function(){const n=(s+d).trim().substring(0,e);if(E.style.opacity="0.2",E.style.transitionDuration="0.3s",E.style.transform="rotate("+360*h+"deg)",n.length<=e){let e=n.length-Math.floor(Math.random()*t);for(;e===y||n.length-e===y;)e=n.length-Math.floor(Math.random()*t);y=e,H(e)}else{let i=Math.floor(Math.random()*t)+e;for(;i===y||n.length-i===y;)i=Math.floor(Math.random()*t)+e;H(i)}h++})),document.getElementById("go-tianli-blog").addEventListener("click",(()=>{window.open(n,"_blank")})),b.addEventListener("click",(async function(){if(!T)return void anzhiyu.snackbarShow("摘要还没加载完呢，请稍后。。。");if(b=v.querySelector(".anzhiyu-icon-circle-dot"),b.style.opacity="0.2",p&&!g)return p.pause(),g=!0,b.style.opacity="1",b.style.animation="",void(b.style.cssText="animation: ''; opacity: 1;cursor: pointer;");if(p&&g)return p.play(),g=!1,void(b.style.cssText="animation: breathe .5s linear infinite; opacity: 0.2;cursor: pointer");const t={key:i,Referer:a},e=new URLSearchParams({key:t.key,id:T}),n={method:"GET",headers:{"Content-Type":"application/json",Referer:t.Referer}};try{const t=await fetch(`https://summary.tianli0.top/audio?${e}`,n);if(403===t.status)console.error("403 refer与key不匹配。");else if(500===t.status)console.error("500 系统内部错误");else{const e=await t.blob(),n=URL.createObjectURL(e);p=new Audio(n),p.play(),b.style.cssText="animation: breathe .5s linear infinite; opacity: 0.2;cursor: pointer",p.addEventListener("ended",(()=>{p=null,b.style.opacity="1",b.style.animation=""}))}}catch(t){console.error("请求发生错误❎")}})),r&&document.getElementById("ai-Toggle").addEventListener("click",(function(){f="fantasy"===f?"local":"fantasy","fantasy"===f?(document.getElementById("ai-tag").innerHTML="FantasyGPT",b.style.opacity="1",b.style.cursor="pointer"):(b.style.opacity="0",b.style.cursor="auto",(document.getElementById("go-tianli-blog").style.display="block")&&(document.querySelectorAll(".ai-btn-item").forEach((t=>t.style.display="block")),document.getElementById("go-tianli-blog").style.display="none"),document.getElementById("ai-tag").innerHTML=o+" GPT");H()})),H(),document.getElementById("ai-tag").innerHTML="fantasy"===f?"FantasyGPT":o+" GPT"}();